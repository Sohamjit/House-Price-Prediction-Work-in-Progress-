---
title: 'House Price Prediction'
author: "Sohamjit Mukherjee"
date: "14 April 2019"
output: html_document
---

---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Loading the Packages

<span style="color:orange"> Let us start by clearing the workspace and installing the required libraries. "SuppressMessages" in the code helps us to not display the unnecessary messages during the installation process.

```{r, error=FALSE, message=FALSE, warning=FALSE, fig.showtext=FALSE}

rm(list=ls())

if(!require(data.table)){
    install.packages("data.table")
    suppressMessages(library(data.table))
}

if(!require(stringr)){
    install.packages("stringr")
    suppressMessages(library(stringr))
}


if(!require(shiny)){
    install.packages("shiny")
    suppressMessages(library(shiny))
}

if(!require(tidyr)){
    install.packages("tidyr")
    suppressMessages(library(tidyr))
}

if(!require(ggplot2)){
    install.packages("ggplot2")
    suppressMessages(library(ggplot2))
}

if(!require(gridExtra)){
    install.packages("gridExtra")
    suppressMessages(library(gridExtra))
}


if(!require(visNetwork)){
    install.packages("visNetwork")
    suppressMessages(library(visNetwork))
}

if(!require(xgboost)){
    install.packages("xgboost")
    suppressMessages(library(xgboost))
}

if(!require(ranger)){
    install.packages("ranger")
    suppressMessages(library(ranger))
}

if(!require(glmnet)){
    install.packages("glmnet")
    suppressMessages(library(glmnet))
}

if(!require(leaflet)){
    install.packages("leaflet")
    suppressMessages(library(leaflet))
}

if(!require(shiny)){
    install.packages("shiny")
    suppressMessages(library(shiny))
}


```



```{r}

df_train = as.data.table(fread("house_price_train.csv" ,stringsAsFactors = T))

```

## Exploratory Data Analysis

### 3.1 Check the overall structure of the data

```{r}

str(df_train)

```

### 3.2 Remove the unwanted columns

```{r}

df_train$id = NULL 
df_train$date = NULL

```

### 3.3 Check for missing values

```{r}

sapply(df_train,function(x) sum(is.na(x)))

```

<span style="color:green"> There are no missing values in any of the columns. The data set is thus cleaned of any missing imputs.

### 3.4 Visualiza the spread of the houses by latitude & logitude (Interactive Graph)

```{r}

leaflet(data = df_train) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, popup = ~as.character(price), 
             label = ~as.character(price))


```

<span style="color:orange"> From the above plot it is almost impossible to find any reasonable insights as the data are too much cluttered. Therefore, we will create another map and integrate in shiny app and provide the users with the ability to fiter the result based on zip code.


### 3.5 Visualiza the spread of the houses by latitude & logitude (in Shinny app)

```{r}
Bedroom3orLess = df_train[bedrooms <=3,]
BedroomBetween3and7 = df_train[bedrooms <=7 & bedrooms >=3 ,]
Bedroom8orGreater = df_train[bedrooms >=8,]


```


### 3.6 Analysis of the bedrooms in the houses

```{r}

# Plot distribution of prices with number of bedrooms

Plot1 = ggplot( df_train , aes(as.factor(bedrooms))) +
  geom_bar(aes(fill = as.factor(floors))) +
  theme_classic() +
  xlab("Number of Bedrooms") +
  ylab("Frequency of the Flats") +
  ggtitle("Frequency of Houses Based on Bedrooms")


# Create a data table with average price per bedrooms

avgprice_bedroom = data.table(aggregate(df_train[, c("price")], list(df_train$bedrooms), mean))

# Rename the column in the data table

names(avgprice_bedroom) = c("Bedrooms" , "AveragePrice")

# Plot the distribution of avg price based on number of bedrooms

Plot2 = ggplot(avgprice_bedroom , aes(Bedrooms, AveragePrice))+
           geom_col(fill="green") +
        ggtitle("Average Price Per Bedrooms") +
        theme_classic() +
       xlab("Number of Bedrooms") +
      ylab("Price") 


# Arange both the plot side by side


grid.arrange(Plot1,Plot2, nrow = 1)

```

<span style="color:blue"> Most of the houses in the dataset has bedrooms 7 or less. There are few cases where the number of bedrooms exceeded 8. Those may be entry errors or they are exception cases. Also, most of the houses in the database are either 1 or 2 stored.

<span style="color:blue"> From the bar plot we can see that the houses with bedrooms 5 to 6 cost the most. Surprisnlgy, the house with 33 bedrooms cost quite less. This points to the fact that this may be an outlier.


## 4 Baseline Model

<span style="color:green"> For the base line model we will simple split the the data set into 75% train and rest 25% into test and check the accuracy.


### 4.1 Model - Linear Model

```{r}

# Create the function to split the test and train data set.

split = function(df, prop = 0.75){

set.seed(6497)
df = data.table(df)
sample = sample.int(n = nrow(df), size = floor(prop*nrow(df)), replace = F)

assign("train", df[sample,] , envir = .GlobalEnv)  
assign("test" , df[-sample,] ,envir = .GlobalEnv)   
}

# Use the function to split on test and train data.

split(df_train , 0.90)

# Run the model.

lm_model = lm(price ~.-price ,data=train)

#Check overall summary.

summary(lm_model)

# Predict on the test data.

lm_pred = predict(lm_model , test)

# Check the error

lm_rmse = rmse(lm_pred, test$price)
lm_mape = mape(lm_pred, test$price)

```

### 4.2 Model - XG Boost

```{r}

# Run the model.

xgb_model = xgboost(data = as.matrix(train[,-1]), nfold = 1, label = as.matrix(train$price), 
                   nrounds = 100, verbose = T, objective = "reg:linear", eval_metric = "rmse", 
                   nthread = 20, eta = 0.1, gamma =0.5, max_depth = 20, min_child_weight = 5, 
                   subsample = 0.6213, colsample_bytree = 0.4603, print_every_n = 20)


#Check overall summary.

summary(xgb_model)

# Predict on the test data.

xgb_pred = predict(xgb_model , as.matrix(test[,-1]))

# Check the error

xgb_rmse = rmse(xgb_pred, test$price)
xgb_mape = mape(xgb_pred, test$price)


```

### 4.3 Model - Randomforest

```{r}

# Run the model.

rf_model = ranger(price ~ . , data = train)


#Check overall summary.

summary(rf_model)

# Predict on the test data.

rf_pred = predict(rf_model , test)$predictions

# Check the error

rf_rmse = rmse(rf_pred, test$price)
rf_mape = mape(rf_pred, test$price)


```

### 4.4 Model - GlMNet

```{r}

# Run the model.

glm_model = glmnet(x = data.matrix(train[, !'price']), 
                 y = train[['price']],
                 family = 'gaussian',
                 alpha=1)


#Check overall summary.

summary(glm_model)

# Predict on the test data.

glm_pred = predict(glm_model , as.matrix(test[, !'price']))

# Check the error

glm_rmse = rmse(glm_pred, test$price)
glm_mape = mape(glm_pred, test$price)


```
